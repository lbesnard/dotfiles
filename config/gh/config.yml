# What protocol to use when performing git operations. Supported values: ssh, https
git_protocol: ssh
# What editor gh should run when creating issues, pull requests, etc. If blank, will refer to environment.
editor:
# When to interactively prompt. This is a global config that cannot be overridden by hostname. Supported values: enabled, disabled
prompt: enabled
# A pager program to send command output to, e.g. "less". Set the value to "cat" to disable the pager.
pager: bat --style plain
# Aliases allow you to create nicknames for gh commands
aliases:
  co: '!id="$(gh pr list -L100 | fzf --no-preview --reverse | cut -f1)"; [ -n "$id" ] && gh pr checkout "$id"'
  _issue_user_repo_view: |-
    !(
    # parse the options
    # ":" -> requires an argument. if no ":" no need for it
    #echo "$@"
    tmp_getops=`getopt -o a:r:m:c,s: --long assignee:,repo:,milestone:,comment,state: -- "$@"`
    eval set -- "$tmp_getops"

    while true ; do
        case "$1" in
            -a|--assignee) user="-a $2"; shift 2;;
            -r|--repo) repo="$2"; shift 2;;
            -m|--milestone) milestone="$2"; shift 2;;
            -c|--comment) comment=true; shift 1;;
            -s|--state) state="-s $2"; shift 2;;
            --) shift; break;;
            *) ;;
        esac
    done

    # option -c to comment an issue or view
    [ -z "$comment" ] && command=view || command=comment

    # check if iteration is top of po-backlog
    [ ! -z "$milestone" ] && (echo "$milestone" | grep -q -i top) && milestone="Top of PO Backlog"

    # milestone values specific to AODN organisation
    if [ -z "$milestone" ]
    then
        id="$(gh issue list -L100 $state $user -R $repo | fzf --preview '(gh issue -R '$repo' view $(echo {} | awk '"'"'{print $1;}'"'"') | mdcat)' --reverse --multi=1 | cut -f1)"
    else
       re_number="^[0-9]+$"
       echo "$milestone" | grep -q -E "$re_number"  && \
                                                  # issue with following command because of git # change, replaced by --search. this will be fixed in the near future https://github.com/cli/cli/issues/4040#issuecomment-887190179
                                                  #id=$(gh issue list -a $user -R $repo --milestone "Iteration $milestone" | fzf --preview '(gh issue -R '$repo' view $(echo {} | awk '"'"'{print $1;}'"'"') | mdcat)' --reverse --multi=1 | cut -f1) || \
                                                  id=$(gh issue list -L100 $user -R $repo $state --search "milestone:\"Iteration $milestone\"" | fzf --preview '(gh issue -R '$repo' view $(echo {} | awk '"'"'{print $1;}'"'"') | mdcat)' --reverse --multi=1 | cut -f1) || \
                                                  # issue with following command because of git # change, replaced by --search. this will be fixed in the near future https://github.com/cli/cli/issues/4040#issuecomment-887190179
                                                  #id=$(gh issue list -a $user -R $repo --milestone "$milestone" | fzf --preview '(gh issue -R '$repo' view $(echo {} | awk '"'"'{print $1;}'"'"') | mdcat)' --reverse --multi=1 | cut -f1)
                                                  id=$(gh issue list -L100 $user -R $repo $state --search "milestone:\"$milestone\"" | fzf --preview '(gh issue -R '$repo' view $(echo {} | awk '"'"'{print $1;}'"'"') | mdcat)' --reverse --multi=1 | cut -f1)
    fi

    # show or comment selected issue
    [ -n "$id" ] && gh issue -R $repo $command "$id"
    )
  issues: |-
    !(case $1 in
     content|issues|backlog|po-backlog|data-services|python-aodntools|python-aodncore|python-aodndata)

        organisation=aodn
        repo="$organisation/$1";

        # re-initiate $ argument "order"
        tmp_getops=`getopt -o c,a,m: --long comment,all,milestone:,closed -- "$@"`
        eval set -- "$tmp_getops"

        while true ; do
            case "$1" in
                -c|--comment) comment="$1"; shift 1;;
                -a|--all) all_users=True; shift 1;;
                -m|--milestone) milestone="-m $2"; shift 2;;
                --closed) state="-s closed"; shift 1;;
                --) shift; break;;
                *) ;;
            esac
        done

        if [ -z "$all_users" ]
        then
            user="$GIT_USER"
            gh _issue_user_repo_view -a $user -r $repo $comment $milestone $state
        else
            gh _issue_user_repo_view -r $repo $comment $milestone $state
        fi

        ;;

     *)

        echo The following commands are supported from '\e[1;31m'gh issues'\e[0m':
        echo '\t\e[1;32m'content,po-backlog,data-services...'\e[0m' '\t list all issues for user from content repo'
        echo '\t\e[1;32m'-m [223, Iteration 223, top]'\e[0m' '\t list all issues for specific milestone'
        echo '\t\e[1;32m'-a --all'\e[0m' '\t list all issues for all users'
        echo '\t\e[1;32m'--closed'\e[0m' '\t list closed issues'

        ;;
      esac)
  project-sprint: |-
    ! (
      GH_PATH="gh"
      ORG="aodn"
      PROJECT_NUMBER=72

      $GH_PATH project item-list $PROJECT_NUMBER --owner "$ORG" --format json \
        --query "assignee:$GIT_USER iteration:@current -status:Done" | \
      jq -r '
        # Priority Color Logic
        def color_prio(raw; padded):
          if raw == "High" then "\u001b[31m" + padded + "\u001b[0m"
          elif raw == "Medium" then "\u001b[33m" + padded + "\u001b[0m"
          elif raw == "Low" then "\u001b[32m" + padded + "\u001b[0m"
          else "\u001b[90m" + padded + "\u001b[0m" end;

        def pad(len): tostring | . + " " * (len - length);

        def prio_weight: 
          if . == "High" then 1 elif . == "Medium" then 2 elif . == "Low" then 3 else 4 end;

        # 1. Collect all unique projects
        (.items | map(.project // "No-Project") | unique) as $unique_projects |
        
        # 2. Assign each a unique color
        [34, 35, 36, 94, 95, 96, 37, 90] as $palette |
        (reduce range(0; $unique_projects | length) as $i ({}; . + {($unique_projects[$i]): $palette[$i % ($palette | length)]})) as $color_map |

        # 3. Sort and Render
        (.items | sort_by(.priority | prio_weight))[] | 
        
        ((.iteration.title // "No-Iter") | pad(15)) as $iter |
        (.priority // "None") as $raw_prio |
        ($raw_prio | pad(8)) as $prio_pad |
        (.project // "No-Project") as $pjt_raw |
        ($pjt_raw | pad(18)) as $pjt_pad |
        ((.content.number // "DRAFT") | tostring | pad(6)) as $num |
        (.content.url // "") as $url |
        
        ($color_map[$pjt_raw]) as $code |
        "\u001b[\($code)m\($pjt_pad)\u001b[0m" as $pjt_colored |
        
        # Added the $url at the end of the string
        "[\($iter)]  \(color_prio($raw_prio; $prio_pad))  \($pjt_colored)  #\($num)  \(.content.title)  \u001b[90m\($url)\u001b[0m"
      '
    )
  project-sprint-taskwarrior: |-
    ! (
      # GH_PATH="/home/lbesnard/github_repo/dotfiles/bin/gh"
      GH_PATH="gh"
      ORG="aodn"
      PROJECT_NUMBER=72

      raw_output=$($GH_PATH project item-list $PROJECT_NUMBER --owner "$ORG" --format json \
        --query "assignee:$GIT_USER iteration:@current -status:Done -status:Closed" | \
      jq -r '
        def color_prio(p):
          if p == "High" then "\u001b[31m" + p + "\u001b[0m"
          elif p == "Medium" then "\u001b[33m" + p + "\u001b[0m"
          elif p == "Low" then "\u001b[32m" + p + "\u001b[0m"
          else "\u001b[90mNone\u001b[0m" end;
        .items[] | 
        (.iteration.title // "No-Iteration") as $iter |
        (.priority // "None") as $prio |
        (.project // "No-Project") as $pjt |
        "\($iter)\t\(color_prio($prio))\t\u001b[36m\($pjt)\u001b[0m\t\(.content.number // "DRAFT")\t\(.content.title)\t\(.content.repository // "none")"
      ' | \
      sort -rV | \
      fzf --ansi --reverse --multi \
          --header "TAB: Select | ENTER: Open | CTRL-T: Taskwarrior" \
          --expect=ctrl-t \
          --delimiter '\t' \
          --with-nth 1,2,3,4,5 \
          --preview-window 'right:60%:wrap' \
          --preview "$GH_PATH issue view {4} -R {6}")

      if [ -z "$raw_output" ]; then exit 0; fi

      key=$(echo "$raw_output" | head -n 1)
      
      echo "$raw_output" | tail -n +2 | perl -pe 's/\e\[[0-9;]*m//g' | while IFS='	' read -r iter prio pjt num title repo; do
        if [ -z "$num" ] || [ "$num" = "DRAFT" ] || [ "$repo" = "none" ]; then
          continue
        fi

        if [ "$key" = "ctrl-t" ]; then
          tw_prio=$(echo "$prio" | cut -c1 | tr '[:lower:]' '[:upper:]')
          case "$tw_prio" in
            H|M|L) ;;
            *) tw_prio="" ;;
          esac

          echo "üì• Importing #$num: $title"
          url=$($GH_PATH issue view "$num" -R "$repo" --json url --jq .url)
          task add "$title ($url)" project:"$pjt" priority:"$tw_prio" due:today +today +github
        else
          echo "üåê Opening #$num in browser..."
          $GH_PATH issue view "$num" -R "$repo" --web
        fi
      done
    )
version: "1"
